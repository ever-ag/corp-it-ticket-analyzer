<!DOCTYPE html>
<html>
<head>
    <title>IT Ticket Analyzer - Upload & Analyze</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background-color: white; padding: 20px; border-radius: 8px; }
        h1 { color: #2c3e50; text-align: center; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
        .upload-area { border: 2px dashed #3498db; padding: 40px; text-align: center; margin: 20px 0; border-radius: 8px; }
        .upload-area:hover { background-color: #f8f9fa; }
        input[type="file"] { margin: 20px 0; }
        button { background-color: #3498db; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #2980b9; }
        .progress { display: none; margin: 20px 0; }
        .progress-bar { width: 100%; height: 20px; background-color: #ecf0f1; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background-color: #3498db; width: 0%; transition: width 0.3s; }
        .results { margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 11px; }
        th, td { border: 1px solid #bdc3c7; padding: 6px; text-align: left; }
        th { background-color: #3498db; color: white; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        .clickable { color: #3498db; cursor: pointer; text-decoration: underline; font-weight: bold; }
        .clickable:hover { background-color: #e8f4fd; }
        .monitoring { background-color: #e8f5e8; }
        .security { background-color: #f0e6ff; }
        .email { background-color: #e6f3ff; }
        .software { background-color: #fff0e6; }
        .user-mgmt { background-color: #f0fff0; }
        .infrastructure { background-color: #ffe6e6; }
        .hardware { background-color: #fff3e0; }
        .maintenance { background-color: #f5f5f5; }
        .mobile { background-color: #e8f4f8; }
        .specialized { background-color: #ffeef8; }
        .general { background-color: #f8f8f8; }
        .admin { background-color: #f0f8ff; }
        .billing { background-color: #fff9e6; }
        .detail-panel { display: none; background-color: #f8f9fa; padding: 10px; margin: 2px 0; border-radius: 5px; border: 1px solid #bdc3c7; }
        .ticket-item { background-color: white; margin: 2px 0; padding: 6px; border-radius: 3px; border-left: 3px solid #3498db; font-size: 9px; }
        .close-btn { float: right; background: #e74c3c; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; }
        .metric { background-color: #e8f4fd; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .automation-tag { background-color: #27ae60; color: white; padding: 1px 4px; border-radius: 3px; font-size: 8px; }
        .download-btn { background-color: #27ae60; margin: 10px 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç IT Ticket Analyzer - Upload & Analyze</h1>
        
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <h3>üìÅ Upload Excel File</h3>
            <p>Click here or drag and drop your Excel file (.xlsx)</p>
            <p><strong>Expected columns:</strong> Description/Subject, Category, Total Time Spent (Hours), Status, Assigned To, etc.</p>
            <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
        </div>
        
        <div class="progress" id="progressDiv">
            <p>Analyzing tickets...</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
        
        <button onclick="downloadReport()" id="downloadBtn" style="display: none;" class="download-btn">üì• Download Analysis Report</button>
        
        <div class="results" id="results"></div>
    </div>

    <script>
        let analysisData = null;
        let ticketData = [];
        
        // Specific patterns for ticket classification
        const specificPatterns = {
            'Billing and Financial Management': ['billing', 'invoice', 'payment', 'cost', 'expense', 'budget', 'migrate.*billing', 'financial.*management'],
            'EverAgCorp247SitePoller Alerts': ['EverAgCorp247SitePoller', 'Site24x7.*Alert.*Mailer'],
            'Intune Setup and Conditional Access': ['intune.*setup', 'conditional.*access', 'intune.*enroll', 'device.*enrollment'],
            '1Password Setup and Management': ['1password', '1 password', 'onepassword', 'password.*manager'],
            'MFA Setup and Issues': ['multi.*factor', 'mfa.*setup', 'two.*factor', '2fa', 'authenticator.*app'],
            'Security Group Management': ['security.*group', 'ad.*group', 'active.*directory.*group'],
            'Email List Management': ['remove.*from.*distribution.*list', 'add.*to.*distribution.*list', 'mailing.*list.*change'],
            'Email Forwarding Setup': ['setup.*email.*forwarding', 'forward.*email.*to', 'email.*forwarding.*request'],
            'Shared Mailbox Management': ['shared.*mailbox', 'mailbox.*access', 'shared.*email'],
            'Software License Requests': ['need.*license.*for', 'request.*license', 'software.*license.*needed'],
            'New User Setup': ['new.*user.*setup', 'new.*employee', 'onboard.*user', 'create.*account'],
            'VPN Setup/Configuration': ['setup.*vpn', 'configure.*vpn', 'vpn.*setup', 'vpn.*access'],
            'SharePoint Access': ['sharepoint.*access', 'sharepoint.*setup', 'sp.*access'],
            'Hardware Requests': ['need.*laptop', 'need.*computer', 'request.*equipment', 'hardware.*request'],
            'Teams Setup': ['teams.*setup', 'microsoft.*teams', 'teams.*access'],
            'Office 365 Setup': ['office.*365', 'o365.*setup', 'microsoft.*365', 'm365']
        };
        
        const generalPatterns = {
            'Password Reset/Account Lockout': ['password.*reset', 'forgot.*password', 'account.*locked'],
            'Email/Outlook Issues': ['email.*not.*work', 'outlook.*issue', 'email.*problem'],
            'Printer/Printing Problems': ['printer.*not.*work', 'cannot.*print', 'printing.*issue'],
            'Network/WiFi Connectivity': ['internet.*not.*work', 'wifi.*issue', 'network.*problem'],
            'Hardware Failure/Issues': ['computer.*not.*start', 'laptop.*broken', 'monitor.*not.*work'],
            'Performance/Speed Issues': ['computer.*slow', 'system.*slow', 'performance.*issue'],
            'Application Crashes/Errors': ['application.*crash', 'software.*error', 'program.*not.*work']
        };
        
        const categoryStyles = {
            'Monitoring & Alerts': 'monitoring',
            'Security & Access': 'security',
            'Email & Communication': 'email',
            'Software & Licensing': 'software',
            'User Management': 'user-mgmt',
            'Infrastructure & Network': 'infrastructure',
            'Hardware & Equipment': 'hardware',
            'System Maintenance': 'maintenance',
            'Mobile & Remote': 'mobile',
            'Specialized Applications': 'specialized',
            'General IT Support': 'general',
            'Administrative Tasks': 'admin',
            'Financial & Billing': 'billing'
        };
        
        document.getElementById('fileInput').addEventListener('change', handleFile);
        
        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('progressDiv').style.display = 'block';
            updateProgress(10);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    updateProgress(30);
                    analyzeTickets(jsonData);
                } catch (error) {
                    alert('Error reading file: ' + error.message);
                    document.getElementById('progressDiv').style.display = 'none';
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function analyzeTickets(data) {
            updateProgress(50);
            
            // Find description column
            const descCol = findColumn(data, ['Description', 'description', 'Description, Description Additional Details, Additional Notes']);
            const subjectCol = findColumn(data, ['Subject', 'subject']);
            const categoryCol = findColumn(data, ['Category', 'category']);
            const timeCol = findColumn(data, ['Total Time Spent (Hours)', 'time', 'hours']);
            const statusCol = findColumn(data, ['Status', 'status']);
            const assignedCol = findColumn(data, ['Assigned To', 'assigned']);
            const ticketNumCol = findColumn(data, ['Help Ticket Number', 'ticket', 'number']);
            
            ticketData = data.map((row, idx) => {
                const description = (row[descCol] || '') + ' ' + (row[subjectCol] || '');
                const category = row[categoryCol] || '';
                
                // Classify ticket
                const classification = classifyTicket(description, category);
                
                return {
                    id: idx,
                    description: description,
                    subject: row[subjectCol] || '',
                    category: category,
                    detectedType: classification.type,
                    typeCategory: classification.category,
                    timeSpent: parseFloat(row[timeCol]) || 0,
                    status: row[statusCol] || '',
                    assignedTo: row[assignedCol] || '',
                    ticketNumber: row[ticketNumCol] || ''
                };
            });
            
            updateProgress(80);
            generateReport();
            updateProgress(100);
            
            setTimeout(() => {
                document.getElementById('progressDiv').style.display = 'none';
                document.getElementById('downloadBtn').style.display = 'inline-block';
            }, 500);
        }
        
        function findColumn(data, possibleNames) {
            if (data.length === 0) return null;
            const firstRow = data[0];
            
            for (let name of possibleNames) {
                if (firstRow.hasOwnProperty(name)) return name;
            }
            
            // Fuzzy match
            const keys = Object.keys(firstRow);
            for (let name of possibleNames) {
                const match = keys.find(key => key.toLowerCase().includes(name.toLowerCase()));
                if (match) return match;
            }
            
            return keys[0]; // fallback to first column
        }
        
        function classifyTicket(text, category) {
            const textLower = text.toLowerCase();
            
            // Check specific patterns
            for (let [type, patterns] of Object.entries(specificPatterns)) {
                for (let pattern of patterns) {
                    if (new RegExp(pattern, 'i').test(textLower)) {
                        return {
                            type: `üéØ ${type}`,
                            category: getCategoryForType(type)
                        };
                    }
                }
            }
            
            // Check general patterns
            for (let [type, patterns] of Object.entries(generalPatterns)) {
                for (let pattern of patterns) {
                    if (new RegExp(pattern, 'i').test(textLower)) {
                        return {
                            type: type,
                            category: 'General IT Support'
                        };
                    }
                }
            }
            
            return {
                type: `Other - ${category}`,
                category: 'General IT Support'
            };
        }
        
        function getCategoryForType(type) {
            if (type.includes('Billing')) return 'Financial & Billing';
            if (type.includes('Intune') || type.includes('MFA') || type.includes('1Password') || type.includes('Security')) return 'Security & Access';
            if (type.includes('Email') || type.includes('Mailbox')) return 'Email & Communication';
            if (type.includes('License') || type.includes('Software') || type.includes('Office')) return 'Software & Licensing';
            if (type.includes('User') || type.includes('Setup')) return 'User Management';
            if (type.includes('VPN') || type.includes('Network')) return 'Infrastructure & Network';
            if (type.includes('Hardware')) return 'Hardware & Equipment';
            if (type.includes('EverAgCorp247SitePoller')) return 'Monitoring & Alerts';
            return 'Specialized Applications';
        }
        
        function generateReport() {
            // Count types and categories
            const typeCounts = {};
            const categoryCounts = {};
            let totalTime = 0;
            
            ticketData.forEach(ticket => {
                typeCounts[ticket.detectedType] = (typeCounts[ticket.detectedType] || 0) + 1;
                categoryCounts[ticket.typeCategory] = (categoryCounts[ticket.typeCategory] || 0) + 1;
                totalTime += ticket.timeSpent;
            });
            
            // Sort by count
            const sortedTypes = Object.entries(typeCounts).sort((a, b) => b[1] - a[1]);
            const sortedCategories = Object.entries(categoryCounts).sort((a, b) => b[1] - a[1]);
            
            // Generate HTML
            let html = `
                <h2>üìä Analysis Results</h2>
                <div class="metric">
                    <strong>Total Tickets:</strong> ${ticketData.length.toLocaleString()} | 
                    <strong>Total Time:</strong> ${totalTime.toFixed(1)} hours | 
                    <strong>Unique Types:</strong> ${Object.keys(typeCounts).length}
                </div>
                
                <h3>Category Summary</h3>
                <table style="width: 60%;">
                    <tr><th>Category</th><th>Count</th><th>%</th></tr>
            `;
            
            sortedCategories.forEach(([category, count]) => {
                const percentage = (count / ticketData.length * 100).toFixed(1);
                html += `<tr><td>${category}</td><td>${count.toLocaleString()}</td><td>${percentage}%</td></tr>`;
            });
            
            html += `
                </table>
                
                <h3>Top Ticket Types</h3>
                <table>
                    <tr><th>Rank</th><th>Ticket Type</th><th>Category</th><th>Count</th><th>%</th><th>Action</th></tr>
            `;
            
            sortedTypes.slice(0, 30).forEach(([type, count], index) => {
                const percentage = (count / ticketData.length * 100).toFixed(1);
                const sampleTicket = ticketData.find(t => t.detectedType === type);
                const category = sampleTicket ? sampleTicket.typeCategory : 'General IT Support';
                const rowClass = categoryStyles[category] || 'general';
                const automation = type.startsWith('üéØ') && count > 20 ? 'HIGH' : (type.startsWith('üéØ') ? 'MEDIUM' : 'LOW');
                
                html += `
                    <tr class="${rowClass}">
                        <td>${index + 1}</td>
                        <td class="clickable" onclick="showDetails('${type.replace(/'/g, "\\'")}', ${count})">${type}</td>
                        <td>${category}</td>
                        <td>${count.toLocaleString()}</td>
                        <td>${percentage}%</td>
                        <td><span class="automation-tag">${automation}</span></td>
                    </tr>
                `;
            });
            
            html += '</table>';
            
            document.getElementById('results').innerHTML = html;
            analysisData = { ticketData, typeCounts, categoryCounts, totalTime };
        }
        
        function showDetails(ticketType, count) {
            const tickets = ticketData.filter(t => t.detectedType === ticketType).slice(0, 10);
            
            let detailHtml = `
                <div style="background-color: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; border: 1px solid #bdc3c7;">
                    <h4>${ticketType} - ${count.toLocaleString()} tickets</h4>
                    <button onclick="this.parentElement.style.display='none'" style="float: right; background: #e74c3c; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer;">‚úï</button>
            `;
            
            tickets.forEach((ticket, i) => {
                const desc = ticket.description.substring(0, 200) + (ticket.description.length > 200 ? '...' : '');
                detailHtml += `
                    <div style="background-color: white; margin: 3px 0; padding: 8px; border-radius: 3px; border-left: 3px solid #3498db; font-size: 10px;">
                        <strong>#${i + 1} - ${ticket.ticketNumber}</strong> | 
                        <strong>${ticket.timeSpent}hrs</strong> | 
                        <strong>${ticket.status}</strong><br>
                        <strong>Subject:</strong> ${ticket.subject}<br>
                        <strong>Description:</strong> ${desc}
                    </div>
                `;
            });
            
            detailHtml += '</div>';
            
            document.getElementById('results').innerHTML += detailHtml;
        }
        
        function downloadReport() {
            if (!analysisData) return;
            
            // Generate complete HTML report
            const reportHtml = generateCompleteReport();
            
            // Create and download file
            const blob = new Blob([reportHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ticket_analysis_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function generateCompleteReport() {
            const { ticketData, typeCounts, categoryCounts, totalTime } = analysisData;
            const sortedTypes = Object.entries(typeCounts).sort((a, b) => b[1] - a[1]);
            
            return `<!DOCTYPE html>
<html>
<head>
    <title>IT Ticket Analysis Report - ${new Date().toLocaleDateString()}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1800px; margin: 0 auto; background-color: white; padding: 20px; border-radius: 8px; }
        h1 { color: #2c3e50; text-align: center; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 10px; }
        th, td { border: 1px solid #bdc3c7; padding: 4px; text-align: left; }
        th { background-color: #3498db; color: white; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        .monitoring { background-color: #e8f5e8; }
        .security { background-color: #f0e6ff; }
        .email { background-color: #e6f3ff; }
        .software { background-color: #fff0e6; }
        .user-mgmt { background-color: #f0fff0; }
        .infrastructure { background-color: #ffe6e6; }
        .hardware { background-color: #fff3e0; }
        .specialized { background-color: #ffeef8; }
        .general { background-color: #f8f8f8; }
        .billing { background-color: #fff9e6; }
        .metric { background-color: #e8f4fd; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .automation-tag { background-color: #27ae60; color: white; padding: 1px 4px; border-radius: 3px; font-size: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç IT Ticket Analysis Report</h1>
        <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
        
        <div class="metric">
            <strong>Total Tickets:</strong> ${ticketData.length.toLocaleString()} | 
            <strong>Total Time:</strong> ${totalTime.toFixed(1)} hours | 
            <strong>Average Time:</strong> ${(totalTime / ticketData.length).toFixed(1)} hours/ticket
        </div>
        
        <h2>üìä All Ticket Types</h2>
        <table>
            <tr><th>Rank</th><th>Ticket Type</th><th>Category</th><th>Count</th><th>%</th><th>Automation</th></tr>
            ${sortedTypes.map(([type, count], index) => {
                const percentage = (count / ticketData.length * 100).toFixed(1);
                const sampleTicket = ticketData.find(t => t.detectedType === type);
                const category = sampleTicket ? sampleTicket.typeCategory : 'General IT Support';
                const rowClass = categoryStyles[category] || 'general';
                const automation = type.startsWith('üéØ') && count > 20 ? 'HIGH' : (type.startsWith('üéØ') ? 'MEDIUM' : 'LOW');
                
                return `<tr class="${rowClass}">
                    <td>${index + 1}</td>
                    <td>${type}</td>
                    <td>${category}</td>
                    <td>${count.toLocaleString()}</td>
                    <td>${percentage}%</td>
                    <td><span class="automation-tag">${automation}</span></td>
                </tr>`;
            }).join('')}
        </table>
        
        <div class="metric">
            <h3>üéØ Key Insights:</h3>
            <ul>
                <li><strong>üéØ Specific Requests:</strong> Items marked with üéØ are automation candidates</li>
                <li><strong>High Automation Potential:</strong> Focus on HIGH automation items for maximum impact</li>
                <li><strong>Process Improvement:</strong> Use this data to create knowledge base articles and self-service solutions</li>
            </ul>
        </div>
    </div>
</body>
</html>`;
        }
        
        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
        }
    </script>
</body>
</html>
